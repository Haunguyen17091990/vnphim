(function($){$.extend(mejs.MepDefaults,{vastAdTagUrl:''});$.extend(MediaElementPlayer.prototype,{buildvast:function(player,controls,layers,media){var t=this;if(t.options.vastAdTagUrl!=''){t.vastLoadAdTagInfo();}
t.buildads(player,controls,layers,media);t.vastSetupEvents();},vastAdTagIsLoading:false,vastAdTagIsLoaded:false,vastStartedPlaying:false,vastAdTags:[],isVastWraper:false,vastSetupEvents:function(){var t=this;t.container.on('mejsprerollstarted',function(){console.log('VAST','mejsprerollstarted');if(t.vastAdTags.length>0){var adTag=t.vastAdTags[0];if(adTag.trackingEvents.start.length>0){for(var i=0,il=adTag.trackingEvents.start.length;i<il;i++){t.adsLoadUrl(adTag.trackingEvents.start[i]);}}
if(!adTag.shown&&adTag.impressions.length>0){for(var i=0,il=adTag.impressions.length;i<il;i++){t.adsLoadUrl(adTag.impressions[i]);}}
adTag.shown=true;}});t.container.on('mejsprerollended',function(){console.log('VAST','mejsprerollended');if(t.vastAdTags.length>0&&t.vastAdTags[0].trackingEvents.complete.length>0){for(var i=0,il=t.vastAdTags[0].trackingEvents.complete.length;i<il;i++){t.adsLoadUrl(t.vastAdTags[0].trackingEvents.complete[i]);}
t.vastAdTags[0].trackingEvents.complete=[];}});},vastSetAdTagUrl:function(url){var t=this;t.options.vastAdTagUrl=url;t.vastAdTagIsLoaded=false;t.vastAdTags=[];},vastLoadAdTagInfo:function(){console.log('loading vast ad data');var t=this;t.adsDataIsLoading=true;t.vastAdTagIsLoading=true;t.vastAdTags=[];t.loadAdTagInfoDirect();},loadAdTagInfoDirect:function(){console.log('loading vast:direct');var t=this;$.ajax({url:t.options.vastAdTagUrl,crossDomain:true,dataType:"xml",success:function(data){console.log('vast:direct:success',data);t.vastParseVastData(data)},error:function(err){console.log('vast:direct:error',err);t.loadAdTagInfoProxy();}});},loadAdTagInfoProxy:function(){console.log('loading vast:proxy:yahoo');var t=this,protocol=location.protocol,hostname=location.hostname,exRegex=RegExp(protocol+'//'+ hostname),yahooUrl="http://images2-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&url="+ encodeURI(t.options.vastAdTagUrl);$.ajax({url:yahooUrl,crossDomain:true,dataType:"xml",success:function(data){console.log('vast:proxy:yahoo:success',data);t.vastParseVastData(data);},error:function(err){console.log('vast:proxy:yahoo:error',err);}});},vastParseVastData:function(data){var t=this;var wraperLoad=false;$(data).find('Ad').each(function(index,node){var adNode=$(node);if(t.vastAdTags.length==0){var adTag={id:adNode.attr('id'),title:$.trim(adNode.find('AdTitle').text()),description:$.trim(adNode.find('Description').text()),impressions:[],clickThrough:$.trim(adNode.find('ClickThrough').text()),mediaFiles:[],ClickTracking:[],trackingEvents:{start:[],firstQuartile:[],midpoint:[],thirdQuartile:[],complete:[]},skipOffset:5,shown:false};t.vastAdTags.push(adTag);}
if(adNode.find('ClickThrough').text()!=""){t.vastAdTags[0].clickThrough=adNode.find('ClickThrough').text();}
adNode.find('Impression').each(function(){t.vastAdTags[0].impressions.push($.trim($(this).text()));});adNode.find('ClickTracking').each(function(){t.vastAdTags[0].ClickTracking.push($.trim($(this).text()));});adNode.find('Tracking').each(function(index,node){var trackingEvent=$(node);if(trackingEvent.attr('event')=="start"){t.vastAdTags[0].trackingEvents.start.push($.trim(trackingEvent.text()));}else if(trackingEvent.attr('event')=="firstQuartile"){t.vastAdTags[0].trackingEvents.firstQuartile.push($.trim(trackingEvent.text()));}else if(trackingEvent.attr('event')=="midpoint"){t.vastAdTags[0].trackingEvents.midpoint.push($.trim(trackingEvent.text()));}else if(trackingEvent.attr('event')=="thirdQuartile"){t.vastAdTags[0].trackingEvents.thirdQuartile.push($.trim(trackingEvent.text()));}else if(trackingEvent.attr('event')=="complete"){t.vastAdTags[0].trackingEvents.complete.push($.trim(trackingEvent.text()));}});if(adNode.find("VASTAdTagURI").text()!=""){var newurl=adNode.find("VASTAdTagURI").text();var nowtime=(new Date()).getTime();newurl=newurl.replace('[Ref_Url]',window.location.href);newurl=newurl.replace('[referrer_url]',window.location.href);newurl=newurl.replace('[Random]',nowtime);newurl=newurl.replace('[timestamp]',nowtime);t.options.vastAdTagUrl=newurl;t.isVastWraper=true;t.loadAdTagInfoDirect();wraperLoad=true;return false;}else{adNode.find('MediaFile').each(function(index,node){var mediaFile=$(node),type=mediaFile.attr('type');if(t.media.canPlayType(type).toString().replace(/no/,'').replace(/false/,'')!=''){t.vastAdTags[0].mediaFiles.push({id:mediaFile.attr('id'),delivery:mediaFile.attr('delivery'),type:mediaFile.attr('type'),bitrate:mediaFile.attr('bitrate'),width:mediaFile.attr('width'),height:mediaFile.attr('height'),url:$.trim(mediaFile.text())});}});adNode.find('Linear').each(function(index,node){var nodeLinear=$(node);if(nodeLinear.attr('skipoffset')!="undefined"){var skip=nodeLinear.attr('skipoffset');try{var a=skip.split(':');skip=(+a[0])*60*60+(+a[1])*60+(+a[2]);}catch(e){skip=5;}
if(!isNaN(skip)){t.vastAdTags[0].skipOffset=skip;}}});}});if(wraperLoad==false){t.vastLoaded();}},vastLoaded:function(){var t=this;t.vastAdTagIsLoaded=true;t.vastAdTagIsLoading=false;t.adsDataIsLoading=false;t.vastStartPreroll();},vastStartPreroll:function(){console.log('vastStartPreroll');var t=this;if(t.vastAdTags.length>0&&t.vastAdTags[0].mediaFiles.length>0){t.options.adsPrerollMediaUrl=t.vastAdTags[0].mediaFiles[0].url;console.log("skip:",t.vastAdTags[0].skipOffset);t.options.adsPrerollAdSkipSeconds=t.vastAdTags[0].skipOffset;t.adsStartPreroll();}}});})(mejs.$);